### Description:

ShowMeCorp intercepted a payload we believe was sent by Gh0stf4c3. We canâ€™t make heads or tails of it. Can you help?

### Payload:

```
powershell -E 'aQBlAHgAIAAoAFsAUwB5AHMAdABlAG0ALgBUAGUAeAB0AC4ARQBuAGMAbwBkAGkAbgBnAF0AOgA6AFUAVABGADgALgBHAGUAdABTAHQAcgBpAG4AZwAoACgAWwBTAHkAcwB0AGUAbQAuAEMAbwBuAHYAZQByAHQAXQA6ADoARgByAG8AbQBCAGEAcwBlADYANABTAHQAcgBpAG4AZwAoACcAYQBXAFYANABLAEYAdABUAGUAWABOADAAWgBXADAAdQBWAEcAVgA0AGQAQwA1AEYAYgBtAE4AdgBaAEcAbAB1AFoAMQAwADYATwBsAFYAVQBSAGoAZwB1AFIAMgBWADAAVQAzAFIAeQBhAFcANQBuAEsAQwBoAGIAVQAzAGwAegBkAEcAVgB0AEwAawBOAHYAYgBuAFoAbABjAG4AUgBkAE8AagBwAEcAYwBtADkAdABRAG0ARgB6AFoAVABZADAAVQAzAFIAeQBhAFcANQBuAEsAQwBkAGgAVgAxAFkAMABTAFUATgBvAFkAbABVAHoAYgBIAHAAawBSADEAWgAwAFQARwB4AFMAYgBHAFYASQBVAFgAVgBTAFYAegBWAHEAWQBqAEoAUwBjAEcASgB0AFoARwBSAFAAYQBuAEIAVwBWAGsAVgBaAE4ARQB4AHIAWgBHAHgAawBSAGsANAB3AFkAMgAxAHMAZABWAHAANQBaADIAOQBYAE0AVQA0ADEAWQB6AE4AUwBiAEcASgBUAE4AVQBSAGkATQBqAFUAeQBXAGwAaABLAE0ARgBoAFUAYgB6AFoAUwBiAGsAcAAyAFkAbABWAEsAYQBHAE0AeQBWAFQASgBPAFIAawA0AHcAWQAyADEAcwBkAFYAcAA1AFoAMgA1AFoAZQBrAHAASABZAHoAQgBzAFIAbABwAEgATwBVADUAVABSAFQAUgAzAFYAMgAxAHcAVQAyAEYAcgBNAFQAVgBSAGEAegBsAGgAVgAwAGQATwBNAEYAWgBFAFMAawB0AGoAVgBuAEIAWQBWAEcAcABCAGIAawB0AFQAYQAzAEIATABVAFQAQgBMAFMAawBoAEMATgBXAFIASABhAEgAWgBpAGIAWABoADIAVwBWAGQAUwBiAEcATgBwAFEAVABsAEoAUgBuAFIAVQBaAFYAaABPAE0ARgBwAFgATQBIAFYAUgBNAGoAbAAxAFoARwAxAFcAZQBXAFIARwBNAEQAWgBQAGEAMQBwADUAWQBqAEkAeABRADEAbABZAFQAbQB4AE8AYQBsAEoAVQBaAEUAaABLAGMARwBKAHQAWQAyADkASwBNAEcAYwB3AFkAegBCAHMAUQBsAEYAVgBSAGsASgBSAFYAVQBaAEMAVQBsAFYARwBSAGsAMAB3AE4AWABwAFYAVwBFAHAARQBWAEYAVgBLAFUAMQBKADYAVQBsAFYATgBiAEUAWgByAFQARABKAG8AZAAxAEYAcQBXAG0AcABrAFYAawBaAHgAVwBrAFoASwBSAGwATgBXAFMAWABsAFMAVgAwAHAASABVAGsAaABrAFIARQAxAHMAYgBHAGgATgBNAEQARgB2AFcAVgBkAFcAVQBtAEoAVgBaAEcAOQBQAFYAMQBvAHgAVABqAEkAeABiAEUANQBHAFUAagBCAFMATQAxAFoASABVAFYAUgBPAGQAMQBKAHUAYwBGAEoAUwBNAEYAVQAxAFUAVABKAE8AVQBHAFEAegBaAEUAcABqAFIAVQBrADEAVQBsAFIAUwBlAEUAMAB3AFMAbABwAFAAVgAyAE0AeABUAFUAVQA1AGMAVgBaAHMAUgBUAEYAUwBWAGwARgAyAFYAVwAxAEYATQAxAFoAdQBSAGoAQgBOAFcARgBKAHYAWgBVAGQAdwBZAFYAVgBJAFkAegBKAFoAYgBUAGwAcQBUAGsAUgBLAFcARgBOAFUAYQBGAGwAVQBNAGsAbAB5AFYARQBoAHMAVgAyAEoAdQBTAGwAZABqAFYARwB0ADQAWQAxAFoAdwBVAFUAMAB6AFMAawBaAFYAUgAwAGwANQBVAFgAcABKAGQAbQBWAHIATQBWAGwAVABhAHoARgA2AFQAawBWAHMAUwAyAE4AVgBNAEQAQgBWAGIAVABWAFoAVABqAEIASgBjAG0ASgBZAGEAegBWAEwAZQBtAHgAeABXAGsAZAA0AGMARgBvAHcAUgBrAEoAUgBWAFUAVQA1AFUARgBOAGoAYwBFAFIAUgBjAEgAQgBhAFcARwBkAG4AUwAwAFoAMABWAEcAVgBZAFQAagBCAGEAVgB6AEIAMQBWAGsAZABXAE4ARwBSAEQATgBVAFoAaQBiAFUANQAyAFcAawBkAHMAZABWAG8AeABNAEQAWgBQAGIARgBaAFYAVQBtAHAAbgBkAFYASQB5AFYAagBCAFYATQAxAEoANQBZAFYAYwAxAGIAawB0AEQAYQBHAEoAVgBNADIAeAA2AFoARQBkAFcAZABFAHgAcgBUAG4AWgBpAGIAbABwAHMAWQAyADUAUwBaAEUAOQBxAGMARQBkAGoAYgBUAGwAMABVAFcAMQBHAGUAbABwAFUAVwBUAEIAVgBNADEASgA1AFkAVgBjADEAYgBrAHQARABaAEUAdABTAGUAbABZAHkAVwBrAFYAawBWADIAUQB4AGIARgBoAFYAVgAyAFIAUgBWAFQAQgBLAFMAVgBsAFYAVQBrAE4AbABiAFYASgBJAFYAMQBSAEMAVwBtAFYAcgBNAFcANQBXAFYARQA1AHoAWgBXADEAUwBTAEYAWgB1AFUAawAxAGgATQBuAGgAUgBWAEUAZAB6AGUARwBKAEgAUwBsAGgAUABXAEcAeABzAFYAbQBzADAAZAAxAGsAeQBNAFYAZABoAFIAMABwAFYAWQB6AEoAawBTADEASgA2AFYAagBKAGEAUgBXAFIAWABaAEQARgBzAFcARgBWAFkAVgBsAGQATgBNAEgAQgAzAFcAawBWAGsAVgBtAEkAdwBjAEUAbABSAGEAbABaAHIAVQBqAEoAbwBNAGwAbAB0AE0AVABSAGsAYgBHAHgAWQBWAFcAMQA0AGEAbQBGAFkAWgBEAE4AVQBSAFUANQBUAFoARABKAFcAVwBWAFYAdABPAFcAbABOAGEAbABaADYAVwBXAHAASwBSADIARQB4AGMARgBsAFQAVwBGAFoAVgBVAGoARgBhAE0AVgBkAHEAVABsAE4AaQBNAEgAUgBWAFkAegBKADAAYQBXAEoAVQBhADMAZABYAGIARwBoAEQAWQBVAFoAdwBSAEUANQBXAFUAbQBGAFcATQBWAHAANQBVAHoAQgBTAFEAbQBNAHcATQBVAFIAaQBSAEcAaABWAFQAVABGAFoAZAAxAFIARwBWAFQARgBOAFYAMABwAEkAWgBIAG8AdwBiAGsAdABUAGEAMwBCAEwAVQBUAEIATABZAFYAZABXAE4ARQB0AEcAZABGAFIAbABXAEUANAB3AFcAbABjAHcAZABWAFoASABWAGoAUgBrAFEAegBWAEcAWQBtADEATwBkAGwAcABIAGIASABWAGEATQBUAEEAMgBUADIAeABXAFYAVgBKAHEAWgAzAFYAUwBNAGwAWQB3AFYAVABOAFMAZQBXAEYAWABOAFcANQBMAFEAMgBoAGkAVgBUAE4AcwBlAG0AUgBIAFYAbgBSAE0AYQAwADUAMgBZAG0ANQBhAGIARwBOAHUAVQBtAFIAUABhAG4AQgBIAFkAMgAwADUAZABGAEYAdABSAG4AcABhAFYARgBrAHcAVgBUAE4AUwBlAFcARgBYAE4AVwA1AEwAUQAyAFIATABVAGwAZABTAGQAbABSAFYAYQBFADkATgBSAG4AQgB4AFYAVwAxAHcAVABtAFYAVgBSAFQAVgBUAFYAVgBaAHIAWQBqAEEAeABTAFYAUgBxAFEAbQBGAGgAYgBFAHAAeABWAEYAaABzAFEAMQBaAEgAVgBsAGwAVQBhAGsASgBoAFYAbgBwAEMATQBWAFUAeABWAFQAUgBrAFYAbABWADYAVgBXADUAcwBZAFYAWQB3AFcAagBCAFcAVgB6AEYAWABZAFUAWgB3AFMARgBaAHUAYgBFAHgAUwBWADEASgAyAFYARgBWAG8AVAAwADEARwBjAEgARgBWAGIAWABCAE8AWgBWAFYASwBWAFYAcABXAGEARQA5AE4AUgBuAEIAWQBUAFUAaABXAFYARgBaAFUAYQBEAEYAVgBWAEUAawAxAFoARQBkAE8AUwBWAE4AdABlAEcAcABOAE0ARABWADMAVwBXAHAASgBNAEcAUgBXAFMAWABoAGoAUwBFAEoAcQBVAG0AcwAwAGQAMQBrAHkATQBWAGQAaABSADAAcABVAFcAagBKADAAYQBXAEoAVQBhADMAZABYAGIARwBoAEQAWQBVAFoAdwBSAEcAVgBIAFMAbABaAE4ATQBuAGcAMgBXAGsAVgBrAFYAMgBSAEYAZQBIAEoAaQBSAGsASgBOAFkAVABBADEATQBsAGwAcwBhAEUATgBsAFYAbgBCAFoAVgBHADUAdwBhAEYAWgA2AGIARABGAFUAUgAzAFIAUABaAEcAMQBLAFcAVgBGAHUAYgBHAEYAWABSAFQAVQAyAFcAVgBaAGoATgBXAFIAVwBVAGwAaABQAFYAMwBSAGgAVgBtAHAAQgBNAGwAUQB5AGQARgBOAGkAUgBtAHQANQBUADEAaABTAGEAbABOAEYAYwBIAE4AWgBlAGsANQBPAFkAMABWADAAVQBsAEIAVQBNAEcANQBMAFUAMgB0AHcAUwAxAEUAOQBQAFMAYwBwAEsAUwBrAHAATwAyAGwAbABlAEMAQQBvAFcAMQBOADUAYwAzAFIAbABiAFMANQBVAFoAWABoADAATABrAFYAdQBZADIAOQBrAGEAVwA1AG4AWABUAG8ANgBWAFYAUgBHAE8AQwA1AEgAWgBYAFIAVABkAEgASgBwAGIAbQBjAG8ASwBGAHQAVABlAFgATgAwAFoAVwAwAHUAUQAyADkAdQBkAG0AVgB5AGQARgAwADYATwBrAFoAeQBiADIAMQBDAFkAWABOAGwATgBqAFIAVABkAEgASgBwAGIAbQBjAG8ASgAyAEYAWABWAGoAUgBKAFEAMgBkAHIAVQBqAEoAbgBkADIATQB6AFUAbQAxAE8AUgAwADEANgBTADEATQAxAFUAMQBwAFgAUgBtAHQAVwBSAHoAbABHAFkAbQAxAFIAYgAwAHQAUgBQAFQAMABuAEsAUwBrAHAASwBRAD0APQAnACkAKQApACkA'
```

### Steps Taken

This one was pretty easy and obvious from the start, clearly this is a base64 encoded powershell script. So step one is to decode the base64 which will show numerous stages of encoding and activity.


#### Note
For the sake of this writeup I just keep putting the decoded output back into the same text file `payload` to cat vs echoing and piping to decode.


***First Decode Pass***

After the first pass we can see that this is going to be a multiple layered encoding. So instead of just decoding once then analyzing functions or activity I just decoded all base64 until there was nothing else to decode.

```
[pj]@PJs-MacBook-Pro~/CTF:
>>cat payload | base64 -D
iex ([System.Text.Encoding]::UTF8.GetString(([System.Convert]::FromBase64String('aWV4KFtTeXN0ZW0uVGV4dC5FbmNvZGluZ106OlVURjguR2V0U3RyaW5nKChbU3lzdGVtLkNvbnZlcnRdOjpGcm9tQmFzZTY0U3RyaW5nKCdhV1Y0SUNoYlUzbHpkR1Z0TGxSbGVIUXVSVzVqYjJScGJtZGRPanBWVkVZNExrZGxkRk4wY21sdVp5Z29XMU41YzNSbGJTNURiMjUyWlhKMFhUbzZSbkp2YlVKaGMyVTJORk4wY21sdVp5Z25ZekpHYzBsRlpHOU5TRTR3V21wU2FrMTVRazlhV0dOMFZESktjVnBYVGpBbktTa3BLUTBLSkhCNWRHaHZibXh2WVdSbGNpQTlJRnRUZVhOMFpXMHVRMjl1ZG1WeWRGMDZPa1p5YjIxQ1lYTmxOalJUZEhKcGJtY29KMGcwYzBsQlFVRkJRVUZCUlVGRk0wNXpVWEpEVFVKU1J6UlVNbEZrTDJod1FqWmpkVkZxWkZKRlNWSXlSV0pHUkhkRE1sbGhNMDFvWVdWUmJVZG9PV1oxTjIxbE5GUjBSM1ZHUVROd1JucFJSMFU1UTJOUGQzZEpjRUk1UlRSeE0wSlpPV2MxTUU5cVZsRTFSVlF2VW1FM1ZuRjBNWFJvZUdwYVVIYzJZbTlqTkRKWFNUaFlUMklyVEhsV2JuSldjVGt4Y1ZwUU0zSkZVR0l5UXpJdmVrMVlTazF6TkVsS2NVMDBVbTVZTjBJcmJYazVLemxxWkd4cFowRkJRVUU5UFNjcERRcHBaWGdnS0Z0VGVYTjBaVzB1VkdWNGRDNUZibU52WkdsdVoxMDZPbFZVUmpndVIyVjBVM1J5YVc1bktDaGJVM2x6ZEdWdExrTnZiblpsY25SZE9qcEdjbTl0UW1GelpUWTBVM1J5YVc1bktDZEtSelYyWkVkV2QxbFhVV2RRVTBKSVlVUkNlbVJIV1RCWmVrMW5WVE5zZW1SSFZuUk1hMnhRVEdzeGJHSlhPWGxsVms0d1kyMVdhR0pVYzJkS1J6VjJaRWRXZDFsWFVYVldNMHB3WkVkVmIwcElRalZrUjJoMlltMTRkbGxYVW14amFYZDNURU5TZDJWWVVtOWlNalZ6WWpKR2ExcFlTWFZVUjFaMVdqTlNiMHRVYzJ0aWJUa3dXbGhDYUZwRE5WUmFWMVp5UzBSQmMwMURiRGhVTTFZd1RGVTFNV0pIZHowbktTa3BLUTBLYVdWNEtGdFRlWE4wWlcwdVZHVjRkQzVGYm1OdlpHbHVaMTA2T2xWVVJqZ3VSMlYwVTNSeWFXNW5LQ2hiVTNsemRHVnRMa052Ym5abGNuUmRPanBHY205dFFtRnpaVFkwVTNSeWFXNW5LQ2RLUldSdlRVaE9NRnBxVW1wTmVVRTVTVVZrYjAxSVRqQmFhbEpxVFhsQ1ZHVllUakJhVnpCMVUxVTRkVlV6VW5sYVYwWjBWVzFXYUZwSFZubExSV1J2VFVoT01GcHFVbXBOZVVKVVpWaE9NRnBYTUhWVFZUaDFVVEk1ZEdOSVNteGpNMDV3WWpJMGRWSXhjSEJqUms0d1kyMVdhR0pUWjJ0aWJUa3dXbGhDYUZwRGVHSlZNMng2WkVkV2RFeHJiRkJNYTA1MllsaENlVnBZVG5waFZ6bDFUR3RPZG1KWVFubGFXRTU2WVZjNWRWUlhPV3RhVmpBMlQydFNiRmt5T1hSalNFcHNZek5OY0V0UlBUMG5LU2twS1E9PScpKSkpO2lleCAoW1N5c3RlbS5UZXh0LkVuY29kaW5nXTo6VVRGOC5HZXRTdHJpbmcoKFtTeXN0ZW0uQ29udmVydF06OkZyb21CYXNlNjRTdHJpbmcoJ2FXVjRJQ2drUjJnd2MzUm1OR016S1M1U1pXRmtWRzlGYm1Rb0tRPT0nKSkpKQ=='))))
```

***Second Pass***

```
[pj]@PJs-MacBook-Pro~/CTF:
>>cat payload | base64 -D
iex([System.Text.Encoding]::UTF8.GetString(([System.Convert]::FromBase64String('aWV4IChbU3lzdGVtLlRleHQuRW5jb2RpbmddOjpVVEY4LkdldFN0cmluZygoW1N5c3RlbS5Db252ZXJ0XTo6RnJvbUJhc2U2NFN0cmluZygnYzJGc0lFZG9NSE4wWmpSak15Qk9aWGN0VDJKcVpXTjAnKSkpKQ0KJHB5dGhvbmxvYWRlciA9IFtTeXN0ZW0uQ29udmVydF06OkZyb21CYXNlNjRTdHJpbmcoJ0g0c0lBQUFBQUFBRUFFM05zUXJDTUJSRzRUMlFkL2hwQjZjdVFqZFJFSVIyRWJGRHdDMllhM01oYWVRbUdoOWZ1N21lNFR0R3VGQTNwRnpRR0U5Q2NPd3dJcEI5RTRxM0JZOWc1ME9qVlE1RVQvUmE3VnF0MXRoeGpaUHc2Ym9jNDJXSThYT2IrTHlWbnJWcTkxcVpQM3JFUGIyQzIvek1YSk1zNElKcU00Um5YN0IrbXk5KzlqZGxpZ0FBQUE9PScpDQppZXggKFtTeXN0ZW0uVGV4dC5FbmNvZGluZ106OlVURjguR2V0U3RyaW5nKChbU3lzdGVtLkNvbnZlcnRdOjpGcm9tQmFzZTY0U3RyaW5nKCdKRzV2ZEdWd1lXUWdQU0JIYURCemRHWTBZek1nVTNsemRHVnRMa2xQTGsxbGJXOXllVk4wY21WaGJUc2dKRzV2ZEdWd1lXUXVWM0pwZEdVb0pIQjVkR2h2Ym14dllXUmxjaXd3TENSd2VYUm9iMjVzYjJGa1pYSXVUR1Z1WjNSb0tUc2tibTkwWlhCaFpDNVRaV1ZyS0RBc01DbDhUM1YwTFU1MWJHdz0nKSkpKQ0KaWV4KFtTeXN0ZW0uVGV4dC5FbmNvZGluZ106OlVURjguR2V0U3RyaW5nKChbU3lzdGVtLkNvbnZlcnRdOjpGcm9tQmFzZTY0U3RyaW5nKCdKRWRv
TUhOMFpqUmpNeUE5SUVkb01ITjBaalJqTXlCVGVYTjBaVzB1U1U4dVUzUnlaV0Z0VW1WaFpHVnlLRWRvTUhOMFpqUmpNeUJUZVhOMFpXMHVTVTh1UTI5dGNISmxjM05wYjI0dVIxcHBjRk4wY21WaGJTZ2tibTkwWlhCaFpDeGJVM2x6ZEdWdExrbFBMa052YlhCeVpYTnphVzl1TGtOdmJYQnlaWE56YVc5dVRXOWtaVjA2T2tSbFkyOXRjSEpsYzNNcEtRPT0nKSkpKQ=='))));iex ([System.Text.Encoding]::UTF8.GetString(([System.Convert]::FromBase64String('aWV4ICgkR2gwc3RmNGMzKS5SZWFkVG9FbmQoKQ=='))))
```
